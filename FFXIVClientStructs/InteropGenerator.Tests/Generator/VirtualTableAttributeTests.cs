using InteropGenerator.Tests.Helpers;
using Xunit;
using VerifyIG = InteropGenerator.Tests.Helpers.IncrementalGeneratorVerifier<InteropGenerator.Generator.InteropGenerator>;

namespace InteropGenerator.Tests.Generator;

public class VirtualTableAttributeTests {
    [Fact]
    public async Task GenerateStaticVirtualTable() {
        const string code = """
                            [global::System.Runtime.InteropServices.StructLayout(global::System.Runtime.InteropServices.LayoutKind.Explicit)]
                            [GenerateInterop]
                            [VirtualTable("E8 ?? ?? ?? ??", 1)]
                            public partial struct TestStruct
                            {
                            }
                            """;

        const string result = """
                              // <auto-generated/>
                              unsafe partial struct TestStruct
                              {
                                  public static class Addresses
                                  {
                                      public static readonly global::InteropGenerator.Runtime.Address StaticVirtualTable = new global::InteropGenerator.Runtime.Address("TestStruct.StaticVirtualTable", "E8 ?? ?? ?? ?? ?? ?? ??", new ushort[] {1}, new ulong[] {0x00000000000000E8}, new ulong[] {0x00000000000000FF}, 0);
                                  }
                                  [global::System.Runtime.InteropServices.StructLayoutAttribute(global::System.Runtime.InteropServices.LayoutKind.Explicit)]
                                  public unsafe partial struct TestStructVirtualTable
                                  {
                                  }
                                  [global::System.Runtime.InteropServices.FieldOffsetAttribute(0)] public TestStructVirtualTable* VirtualTable;
                                  public static TestStructVirtualTable* StaticVirtualTablePointer => (TestStructVirtualTable*)Addresses.StaticVirtualTable.Value;
                              }
                              """;

        await VerifyIG.VerifyGeneratorAsync(
            code,
            ("TestStruct.InteropGenerator.g.cs", result),
            SourceGeneration.GetInitializerSource(string.Empty, "TestStruct", ["StaticVirtualTable"]));
    }

    [Fact]
    public async Task GenerateStaticVirtualTable_MultipleOffsets() {
        const string code = """
                            [global::System.Runtime.InteropServices.StructLayout(global::System.Runtime.InteropServices.LayoutKind.Explicit)]
                            [GenerateInterop]
                            [VirtualTable("E8 ?? ?? ?? ??", [1, 5])]
                            public partial struct TestStruct
                            {
                            }
                            """;

        const string result = """
                              // <auto-generated/>
                              unsafe partial struct TestStruct
                              {
                                  public static class Addresses
                                  {
                                      public static readonly global::InteropGenerator.Runtime.Address StaticVirtualTable = new global::InteropGenerator.Runtime.Address("TestStruct.StaticVirtualTable", "E8 ?? ?? ?? ?? ?? ?? ??", new ushort[] {1, 5}, new ulong[] {0x00000000000000E8}, new ulong[] {0x00000000000000FF}, 0);
                                  }
                                  [global::System.Runtime.InteropServices.StructLayoutAttribute(global::System.Runtime.InteropServices.LayoutKind.Explicit)]
                                  public unsafe partial struct TestStructVirtualTable
                                  {
                                  }
                                  [global::System.Runtime.InteropServices.FieldOffsetAttribute(0)] public TestStructVirtualTable* VirtualTable;
                                  public static TestStructVirtualTable* StaticVirtualTablePointer => (TestStructVirtualTable*)Addresses.StaticVirtualTable.Value;
                              }
                              """;

        await VerifyIG.VerifyGeneratorAsync(
            code,
            ("TestStruct.InteropGenerator.g.cs", result),
            SourceGeneration.GetInitializerSource(string.Empty, "TestStruct", ["StaticVirtualTable"]));
    }

    [Fact]
    public async Task GenerateStaticVirtualTableWithSize() {
        const string code = """
                            [global::System.Runtime.InteropServices.StructLayout(global::System.Runtime.InteropServices.LayoutKind.Explicit)]
                            [GenerateInterop]
                            [VirtualTable("E8 ?? ?? ?? ??", 1, 5)]
                            public partial struct TestStruct
                            {
                            }
                            """;

        const string result = """
                              // <auto-generated/>
                              unsafe partial struct TestStruct
                              {
                                  public static class Addresses
                                  {
                                      public static readonly global::InteropGenerator.Runtime.Address StaticVirtualTable = new global::InteropGenerator.Runtime.Address("TestStruct.StaticVirtualTable", "E8 ?? ?? ?? ?? ?? ?? ??", new ushort[] {1}, new ulong[] {0x00000000000000E8}, new ulong[] {0x00000000000000FF}, 0);
                                  }
                                  [global::System.Runtime.InteropServices.StructLayoutAttribute(global::System.Runtime.InteropServices.LayoutKind.Explicit, Size = 40)]
                                  public unsafe partial struct TestStructVirtualTable
                                  {
                                  }
                                  [global::System.Runtime.InteropServices.FieldOffsetAttribute(0)] public TestStructVirtualTable* VirtualTable;
                                  public static TestStructVirtualTable* StaticVirtualTablePointer => (TestStructVirtualTable*)Addresses.StaticVirtualTable.Value;
                              }
                              """;

        await VerifyIG.VerifyGeneratorAsync(
            code,
            ("TestStruct.InteropGenerator.g.cs", result),
            SourceGeneration.GetInitializerSource(string.Empty, "TestStruct", ["StaticVirtualTable"]));
    }
}
